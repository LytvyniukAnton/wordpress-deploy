# ---
# - name: Download aaPanel installer
#   ansible.builtin.get_url:
#     url: https://www.aapanel.com/script/install-en.sh
#     dest: /tmp/install.sh
#     mode: '0755'

# - name: Install aaPanel
#   ansible.builtin.shell: |
#     bash /tmp/install.sh install_ubuntu_22 no no 8888
#   args:
#     creates: /www/server/panel
#   async: 300 # Wait up to 300 seconds for the task to finish
#   poll: 0    # Do not wait for the task to finish before starting the next task

# - name: Wait for server to reboot
#   ansible.builtin.wait_for_connection:
#     delay: 60
#     timeout: 600

---
- name: Download aaPanel installer
  ansible.builtin.get_url:
    url: https://www.aapanel.com/script/install-en.sh
    dest: /tmp/install.sh
    mode: '0755'

- name: Install aaPanel
  ansible.builtin.shell: bash /tmp/install.sh install_ubuntu_22 no no 8888
  args:
    creates: /www/server/panel

- name: Wait until aaPanel panel directory exists
  ansible.builtin.wait_for:
    path: /www/server/panel
    state: directory
    timeout: 600
    sleep: 10

- name: Wait until aaPanel process is running
  ansible.builtin.wait_for:
    port: 8888
    host: 127.0.0.1
    delay: 10
    timeout: 300

- name: Check if aaPanel service is running
  ansible.builtin.shell: ps aux | grep -v grep | grep bt
  register: bt_process
  failed_when: bt_process.stdout == ""
